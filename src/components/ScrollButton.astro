---
// src/components/ScrollButton.astro
// Floating scroll button - scrolls down when at top, scrolls up when scrolled
---

<button
  id="scroll-btn"
  class="fixed bottom-6 right-6 z-40 w-12 h-12 rounded-full bg-white text-black flex items-center justify-center shadow-[0_0_20px_rgba(255,255,255,0.15)] opacity-0 pointer-events-none transition-all duration-300 hover:scale-110 active:scale-95 border-0 cursor-pointer"
  aria-label="Scorri in basso"
>
  <svg id="scroll-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300">
    <polyline points="6 9 12 15 18 9"></polyline>
  </svg>
</button>

<script>
  let scrollHandler = null;
  let clickHandler = null;

  function cleanupScrollBtn() {
    if (scrollHandler) {
      window.removeEventListener('scroll', scrollHandler);
      scrollHandler = null;
    }
    if (clickHandler) {
      const btn = document.getElementById('scroll-btn');
      btn?.removeEventListener('click', clickHandler);
      clickHandler = null;
    }
  }

  function initScrollBtn() {
    cleanupScrollBtn();

    const btn = document.getElementById('scroll-btn');
    const icon = document.getElementById('scroll-icon');
    if (!btn || !icon) return;

    let isAtTop = true;
    let ticking = false;

    function update() {
      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      const docHeight = document.documentElement.scrollHeight;

      // Show button after scrolling 200px or if page is long enough to scroll
      const showBtn = docHeight > viewportHeight + 200;
      if (!showBtn) {
        btn.style.opacity = '0';
        btn.style.pointerEvents = 'none';
        return;
      }

      // Always visible once page is scrollable
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';

      // Switch direction: down arrow at top, up arrow when scrolled
      if (scrollY > 300) {
        if (isAtTop) {
          isAtTop = false;
          icon.style.transform = 'rotate(180deg)';
          btn.setAttribute('aria-label', 'Torna in alto');
        }
      } else {
        if (!isAtTop) {
          isAtTop = true;
          icon.style.transform = 'rotate(0deg)';
          btn.setAttribute('aria-label', 'Scorri in basso');
        }
      }
    }

    scrollHandler = () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          update();
          ticking = false;
        });
        ticking = true;
      }
    };

    clickHandler = () => {
      if (isAtTop) {
        // Scroll to bottom of first viewport (next section)
        window.scrollTo({ top: window.innerHeight, behavior: 'smooth' });
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    };

    window.addEventListener('scroll', scrollHandler, { passive: true });
    btn.addEventListener('click', clickHandler);

    // Run once on init
    update();
  }

  document.addEventListener('astro:page-load', initScrollBtn);
  document.addEventListener('astro:before-swap', cleanupScrollBtn);
</script>
