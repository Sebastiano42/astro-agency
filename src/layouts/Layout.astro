---
// src/layouts/Layout.astro
import { ClientRouter } from 'astro:transitions';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import CursorFollower from '../components/CursorFollower.astro';
import CursorDot from '../components/CursorDot.astro';
import ScrollButton from '../components/ScrollButton.astro';
import MockupTilt from '../components/MockupTilt.astro';
import '../styles/global.css';

interface Props {
	title?: string;
	description?: string;
	ogImage?: string;
	ogType?: string;
	noindex?: boolean;
}

const {
	title = "Sebastiano Moniaci",
	description = "Costruisco esperienze digitali che definiscono il futuro dei brand. Web design, sviluppo e digital marketing a Rovigo.",
	ogImage = "/og-image.jpg",
	ogType = "website",
	noindex = false
} = Astro.props;

const isHome = title === "Home";
const pageTitle = isHome
	? "Sebastiano Moniaci - Web Designer & Developer a Rovigo"
	: `${title} | Sebastiano Moniaci`;

const smoothPage = {
	forwards: {
		old: [{
			name: 'pageFadeOut',
			duration: '0.15s',
			easing: 'ease-in',
			fillMode: 'forwards',
		}],
		new: [{
			name: 'pageFadeSlideIn',
			duration: '0.3s',
			easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
			fillMode: 'backwards',
			delay: '0.05s',
		}],
	},
	backwards: {
		old: [{
			name: 'pageFadeOut',
			duration: '0.15s',
			easing: 'ease-in',
			fillMode: 'forwards',
		}],
		new: [{
			name: 'pageFadeSlideIn',
			duration: '0.3s',
			easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
			fillMode: 'backwards',
			delay: '0.05s',
		}],
	},
};

// Construct full URL for canonical and OG
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const fullOgImage = new URL(ogImage, Astro.site);

// Schema.org JSON-LD - Organization & Website
const organizationSchema = {
	"@context": "https://schema.org",
	"@type": "Person",
	"name": "Sebastiano Moniaci",
	"url": Astro.site,
	"logo": new URL("/logo.png", Astro.site),
	"description": "Freelance web designer e developer a Rovigo. Creo esperienze digitali che definiscono il futuro dei brand.",
	"address": {
		"@type": "PostalAddress",
		"addressLocality": "Rovigo",
		"addressCountry": "IT"
	},
	"contactPoint": {
		"@type": "ContactPoint",
		"contactType": "customer service",
		"email": "info@sebastianomoniaci.it",
		"availableLanguage": ["it", "en"]
	},
	"sameAs": [
		"https://www.linkedin.com/in/sebastianomoniaci",
		"https://www.instagram.com/sebastianomoniaci",
		"https://twitter.com/sebastianomoniaci"
	]
};

const websiteSchema = {
	"@context": "https://schema.org",
	"@type": "WebSite",
	"name": "Sebastiano Moniaci",
	"url": Astro.site,
	"description": "Freelance Web Designer & Developer",
	"inLanguage": "it-IT"
};
---

<!doctype html>
<html lang="it">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, viewport-fit=cover" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />

		<!-- Primary Meta Tags -->
		<title>{pageTitle}</title>
		<meta name="title" content={pageTitle} />
		<meta name="description" content={description} />
		{noindex && <meta name="robots" content="noindex, nofollow" />}

		<!-- Canonical URL -->
		<link rel="canonical" href={canonicalURL} />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={ogType} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={fullOgImage} />
		<meta property="og:site_name" content="Sebastiano Moniaci" />
		<meta property="og:locale" content="it_IT" />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={pageTitle} />
		<meta property="twitter:description" content={description} />
		<meta property="twitter:image" content={fullOgImage} />

		<!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"></noscript>

		<!-- Schema.org JSON-LD -->
		<script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
		<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

		<!-- Client Router (replaces deprecated ViewTransitions) -->
		<ClientRouter fallback="swap" />
	</head>
	<body>
    <Navigation transition:persist />

		<main id="main-content" class="overflow-x-hidden" transition:animate={smoothPage}>
      <slot />
    </main>

    <Footer transition:persist />

    <CursorFollower />
    <CursorDot />
    <MockupTilt />
    <ScrollButton />

    <script>
      let currentObserver = null;
      let smoothScrollCleanups = [];

      // Cleanup before every page swap to prevent memory leaks
      document.addEventListener('astro:before-swap', () => {
        if (currentObserver) {
          currentObserver.disconnect();
          currentObserver = null;
        }
        smoothScrollCleanups.forEach(fn => fn());
        smoothScrollCleanups = [];
      });

      // After swap: ensure body scroll is restored
      document.addEventListener('astro:after-swap', () => {
        document.body.classList.remove('overflow-hidden');
      });

      // Scroll Reveal Animation System
      const initAnimations = () => {
        if (currentObserver) {
          currentObserver.disconnect();
        }

        const isMobile = window.matchMedia('(pointer: coarse)').matches;
        const observerOptions = {
          root: null,
          rootMargin: isMobile ? '0px' : '-50px 0px',
          threshold: isMobile ? 0.1 : 0.25
        };

        currentObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('active');
              currentObserver?.unobserve(entry.target);
            }
          });
        }, observerOptions);

        document.querySelectorAll('[class*="reveal"]:not(.active)').forEach(el => {
          currentObserver.observe(el);
        });
      };

      // Smooth scroll for anchor links (with cleanup)
      const initSmoothScroll = () => {
        smoothScrollCleanups.forEach(fn => fn());
        smoothScrollCleanups = [];

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          const handler = function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          };
          anchor.addEventListener('click', handler);
          smoothScrollCleanups.push(() => anchor.removeEventListener('click', handler));
        });
      };

      document.addEventListener('astro:page-load', () => {
        initAnimations();
        initSmoothScroll();
      });
    </script>
	</body>
</html>
